SNAPSHOT v0.12.2 — Authoritative project state (incremental over v0.12.1)

PRODUCT PROMISE
Castra provides a reliable, agent-first workflow to bring ephemeral VMs up, run work within them via agent sessions over SSH, surface live system events in a TUI, and tear everything down cleanly. Users can: initialize a project, bootstrap VMs, connect agents, interact via the TUI, monitor status/logs, and shut down without residue.

CODE STATE (user-visible surfaces and behaviors)
- Core (castra-core)
  - CLI entrypoint (src/main.rs, cli.rs): commands up, down, status, logs, clean, init. Options via core::options; events via core::events; reporting via core::reporter.
  - Bootstrap & VM lifecycle (core/bootstrap.rs, app/up.rs, app/down.rs, app/clean.rs): brings up ephemeral VMs per castra.toml/bootstrap.toml; examples (minimal-bootstrap, bootstrap-quickstart) demonstrate configs and run.sh integration; app.env payload is applied during bootstrap.
    • Vizier-specific planning/steps/status have been fully removed; bootstrap steps are now: wait-handshake, connect, transfer, apply, verify.
  - Event contract v1 (docs/event-contract-v1.md): core emits structured events for lifecycle, logs, diagnostics, status, bootstrap. No vizier.remote family; additive “usage” summaries apply to harness/agents.
  - Status and diagnostics (core/status.rs, core/diagnostics.rs): observable state (started, healthy, failed, shutting down) and error surfaces.
  - Workspace/project registry (core/workspace_registry.rs, core/project.rs): discovers and tracks the active workspace; aligns with docs/WORKSPACE.md. Config loading via src/config.rs.
  - Operations and logs (core/operations/*, core/logs.rs): support clean and log streaming for visible resources.

- UI (castra-ui — TUI)
  - Entry (src/main.rs) with controller and state; components: roster_sidebar, message_log, prompt_shell, status_footer. Legacy vm_fleet remains as rendering of VM states but roster is primary.
  - Agent-first interaction: UI routes prompts through a Codex harness session today; direct SSH session manager is pending. Vizier strings/paths removed; prompt shell targets the active agent (roster-selected).
  - Consumes event contract v1 from core; also consumes harness metadata and usage events.

- Harness (castra-harness)
  - Remote execution scaffolding (runner.rs, session.rs, stream.rs) and translation into UI-facing events; discovery/metadata for SSH wrappers.
  - Vizier remote modules/config have been removed; public API no longer exposes vizier_remote types.
  - Prompt seed reframed from “workspace coordinator”; vm_commands.sh is the endorsed remote runner interface.

- Protocol (castra-protocol)
  - Shared types for event/message exchange between core/UI/harness remain; protocol no longer references vizier.remote.

- VM Command Wrapper
  - vm_commands.sh: remote runner helper for sending commands, listing runs, interrupting by PGID, and viewing output. Environment via SSH_TARGET (+ SSH_PORT/SSH_EXTRA_OPTS, optional SSH_STRICT=1).
  - Run artifacts live under /run/castra-agent/<RUN_ID>/. Use list/view-output to inspect. SESSION names use “agent-<RUN_ID>”.

- Examples & Docs
  - examples/library_up.rs uses operations::up (no launcher shim) and vizier mentions removed.
  - Docs (ARCHITECTURE_HIGH_LEVEL.md, BOOTSTRAP.md, WORKSPACE.md, event-contract-v1.md, castra-ui/docs) updated to remove vizier and describe direct SSH metadata and usage flows.

NARRATIVE STATE (themes, tensions, direction)
- Agent-first model is the North Star: UI owns agent SSH sessions; harness provides discovery/transport metadata; core focuses on VM bootstrap and emitting event contract v1.
- Vizier Removal arc is COMPLETE: vizier references are removed across core, UI, harness, protocol, docs, and tooling. Any remaining work now lives under general UX/operations threads (not “vizier removal”).
- Observability and operational clarity: attention model work continues; message log should reflect focus and collapse noise.
- Ephemerality is a feature: VMs and artifacts should cleanly disappear on shutdown/clean; vm_commands.sh run dirs under /run/castra-agent must be cleaned up deterministically.

ACTIVE THREADS (linked to TODOs; acceptance anchored to current code surfaces)
- Operational clarity / Attention model — todo_operational_clarity_attention_model.md
  - Acceptance anchors: status_footer reflects focus/health; roster shows agent/session presence; message_log filters by attention state; contract v1 alignment.
- Agent-first interaction model — todo_agent_first_interaction_model.md
  - Acceptance anchors: first-message roundtrip over SSH sessions; prompt_shell UX validates live agent responsiveness; transcript preserved.
- Ephemeral VM storage & cleanup — todo_ephemeral_vm_storage_and_cleanup.md
  - Acceptance anchors: down/clean leave no residual processes, storage, or sockets; /run/castra-agent/* garbage-collected with safe windows.
- CLI/Core remove VM-selection surfaces — todo_cli_and_core_remove_vm_selection_surfaces.md
  - Acceptance anchors: CLI avoids direct VM targeting UI now owns; options shape matches agent-first design.
- Core library composability — todo_core_library_composability.md
  - Acceptance anchors: castra-core emits events independent of external shims; examples show embedding via operations::up.
- UI signal filtering & grouping — todo_ui_signal_filtering_grouping.md
  - Acceptance anchors: message_log and roster present grouped, de-duplicated signals keyed by attention and session identity.
- Cooperative shutdown lifecycle — todo_cooperative_shutdown_lifecycle.md
  - Acceptance anchors: orderly teardown across UI→harness→core with user-visible progress; SIGINT/interrupt propagates via vm_commands.sh semantics.
- UI onboarding/tutorials — todo_ui_component_tutorials_onboarding_v1.md
  - Acceptance anchors: first_up tutorial shows bootstrap→connect→interact→shutdown using agent-first model and vm_commands.sh wrappers.

KNOWN CONSTRAINTS
- Must adhere to event-contract v1 shapes; consumers rely on these structures.
- Remote execution mediated by vm_commands.sh; SSH semantics (PGID interrupt, run logs path /run/castra-agent/<RUN_ID>/) are stable and referenced by UI/harness flows.
- Correctness and clean teardown take precedence over raw performance.

NEAR-TERM DIRECTION (what “done” looks like next)
- Land UI session manager with reconnect, attention-integrated status, and prompt_shell bound to SSH sessions (non-vizier specific).
- Validate vm_commands.sh usage in examples/docs and align any lingering paths.
- Harden cooperative shutdown and ephemeral cleanup with user-visible confirmations and deterministic log retention windows under /run/castra-agent.
