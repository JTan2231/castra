SNAPSHOT v0.10.0-pre — Castra (Agent-centric orchestration) — Busless vizier pivot

Edits since previous snapshot
- Clarified remote runner expectations: vm_commands.sh is the canonical harness driver during the busless pivot. Use send/interrupt/list + stdout/stderr fetches as the acceptance harness for stream/golden tests.
- No new code landed since last snapshot; threads updated with crisper acceptance criteria tied to the remote runner and UI event shaping.

Active threads (intent + acceptance deltas)
- Thread 2 — Cooperative shutdown lifecycle: unchanged.

- Thread 12 — Post-boot bootstrap pipeline: unchanged.

- Thread 13 — Stateless runs (ephemeral-only): unchanged.

- Thread 20 — Harness ↔ Core integration (Vizier-first): acceptance tightened
  - Evidence: UI pumps HarnessEvent (pump_codex/pump_vizier) and renders Vizier command/system outputs; transcripts capture these.
  - Gap: unified agent-addressed stream still originates UI-side for SSH; harness-side vizier.ssh.* stream + version preamble and golden tests remain outstanding.
  - Acceptance (near-term):
    - Harness emits a single, versioned vizier SSH event stream with preamble on connect.
    - Stream is consumable and verifiable via vm_commands.sh remote runner (send → capture stdout → assert preamble + framing invariants).
    - Golden test fixtures checked in alongside harness tests.

- Thread 21 — Operational clarity (Attention model): partial delivery; grouping next
  - Evidence: Collapsible messages, scroll behavior, and log soft limit reduce noise and protect responsiveness.
  - Gap: Event grouping/coalescing and per-agent context panes not yet shipped.
  - Acceptance (next increment):
    - Message log groups sequential tool/reasoning bursts; offers one-click expand-all within group.
    - Footer shows per-agent token tallies; click opens agent context pane.

- Thread 22 — UI onboarding docs (tutorial set): unchanged.

- Thread 30 — Busless architecture cutover (Core): pruning staged
  - Evidence: broker/bus types remain in core options; bus scripts still present.
  - Acceptance (initial cut):
    - Remove broker handshake/contract artifacts from core schema/options without breaking current CLI UX.
    - Deprecation notice in docs with migration hints.

- Thread 31 — Agent-first interaction model: in progress (consumers); roster pivot next
  - Evidence: UI distinguishes Vizier activity and tallies usage; foundation for agent-addressed flow.
  - Gap: Roster still VM-centric; CLI/core still expose VM-selection surfaces.
  - Acceptance (UI slice):
    - Roster sidebar lists agents instead of VMs; clicking filters transcript to that agent.

Current code state (observable surfaces)
- Core: options.rs still contains broker/bus-related types and VM-oriented options; broker/bus modules/tests/scripts exist.
- Harness: Unified, agent-addressed stream not yet implemented; SSH integration remains UI-side. No change in harness code structure.
- UI:
  - message_log: collapsible Reasoning/Tool messages; click-to-expand; truncation notice; improved scroll handling.
  - state: new MessageKind::VizierCommand; token usage tracking; transcript writer integration.
  - shell/prompt: Stop control during active Codex turn; wider default window.
  - vm_fleet.rs remains VM-centric; agent roster not yet present.
- Tooling: vm_commands.sh supports `send`, `interrupt`, `list`, `--wait` streaming, and `view-output` to stream and later fetch outputs; serves as acceptance harness for stream verification.
- Docs: README documents transcript recording location and schema summary.

Narrative themes
- Busless, agent-first pivot remains the north star. We are consolidating around a verifiable event stream with golden tests, while reducing UI noise and preparing the roster pivot.

Direction of travel
- Next increments: implement harness-side vizier SSH stream with versioned preamble and golden tests (Thread 20); pivot UI roster to agents and add grouping (Threads 31, 21); begin pruning bus-era scripts and options with clear deprecation notes (Thread 30).

Cross-links
- Thread 20: castra-harness/src/{session.rs,runner.rs,stream.rs,events.rs,translator.rs}; UI consumer in castra-ui/src/app/mod.rs (pump_codex/pump_vizier). Tooling anchor: vm_commands.sh.
- Thread 21: castra-ui/src/components/{message_log.rs,shell.rs}; castra-ui/src/state/mod.rs.
- Thread 30: castra-core/src/core/options.rs; scripts/* bus-era artifacts.
- Thread 31: castra-ui/src/components/roster_sidebar.rs and vm_fleet.rs (to be replaced/pivoted).

Editorial housekeeping
- Canonical TODOs updated with acceptance criteria tied to remote runner harness, grouping, and roster pivot; no new threads opened.